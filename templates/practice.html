<script>
    let allProblemsData = [];

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/get-problems')
            .then(response => response.ok ? response.json() : Promise.reject(response))
            .then(data => {
                allProblemsData = data;
                renderCategoryFilter(allProblemsData);
                renderProblems(allProblemsData);
            })
            .catch(error => {
                console.error('Error fetching problems:', error);
                document.getElementById('problems-display').innerHTML = '<p class="error-message">Failed to load problems.</p>';
            });
    });

    function renderCategoryFilter(data) {
        const filterContainer = document.getElementById('category-filter');
        data.forEach(categoryGroup => {
            const button = document.createElement('button');
            button.className = 'filter-button';
            button.dataset.category = categoryGroup.category;
            button.textContent = categoryGroup.category;
            button.addEventListener('click', () => filterProblems(categoryGroup.category));
            filterContainer.appendChild(button);
        });
        document.querySelector('.filter-button[data-category="all"]').addEventListener('click', () => filterProblems('all'));
    }

    function filterProblems(selectedCategory) {
        document.querySelectorAll('.filter-button').forEach(button => {
            button.classList.toggle('active', button.dataset.category === selectedCategory);
        });
        const dataToRender = (selectedCategory === 'all')
            ? allProblemsData
            : allProblemsData.filter(group => group.category === selectedCategory);
        renderProblems(dataToRender);
    }

    function renderProblems(dataToRender) {
        const problemsDisplay = document.getElementById('problems-display');
        problemsDisplay.innerHTML = '';

        if (!dataToRender || dataToRender.length === 0) {
            problemsDisplay.innerHTML = '<p>No problems found for this category.</p>';
            return;
        }

        let problemIdCounter = 0;
        dataToRender.forEach(categoryGroup => {
            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            const categoryTitle = document.createElement('h2');
            categoryTitle.textContent = categoryGroup.category;
            categorySection.appendChild(categoryTitle);
            categoryGroup.problems.forEach(problemObj => {
                const problemCard = document.createElement('div');
                problemCard.className = 'problem-card';
                const hintId = `hint-${problemIdCounter}`;
                const solutionId = `solution-${problemIdCounter}`;
                const answerInputId = `answer-input-${problemIdCounter}`;
                const encodedAnswer = btoa(problemObj.answer);
                problemCard.innerHTML = `
                    <p class="problem-statement"><strong>Problem:</strong> ${problemObj.problem}</p>
                    <div class="user-answer-section">
                        <label for="${answerInputId}">Your Answer:</label>
                        <textarea id="${answerInputId}" class="user-answer-input" rows="3" placeholder="e.g., 2*x + cos(x)"></textarea>
                        <button class="submit-answer-button" onclick="handleSubmitAnswer('${answerInputId}', '${encodedAnswer}')">Submit Answer</button>
                        <button class="clear-answer-button" onclick="clearAnswer('${answerInputId}')">Clear</button>
                        <div id="feedback-${answerInputId}" class="answer-feedback"></div>
                    </div>
                    ${problemObj.hint ? `<button class="toggle-button" onclick="toggleVisibility(this, '${hintId}')">Show Hint</button>` : ''}
                    <button class="toggle-button" onclick="toggleVisibility(this, '${solutionId}')">Show Solution</button>
                    ${problemObj.hint ? `<div id="${hintId}" class="hidden hint-content"><p><strong>Hint:</strong> ${problemObj.hint}</p></div>` : ''}
                    <div id="${solutionId}" class="hidden solution-content"><p><strong>Solution:</strong> ${problemObj.solution}</p></div>
                `;
                categorySection.appendChild(problemCard);
                problemIdCounter++;
            });
            problemsDisplay.appendChild(categorySection);
        });

        MathJax.typesetPromise([problemsDisplay]).catch(err => console.log('MathJax Typeset Error: ', err));
    }

    function toggleVisibility(button, elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            const isHidden = element.classList.toggle('hidden');
            button.textContent = isHidden ? button.textContent.replace('Hide', 'Show') : button.textContent.replace('Show', 'Hide');
        }
    }

    function preProcessForMathJS(str) {
        if (!str) return '';
        return str
            .replace(/\\(t|d)?frac\s*\{([^}]+)\}\s*\{([^}]+)\}/g, '(($2)/($3))')
            .replace(/\\\(|\\\)/g, '')
            .replace(/\\/g, '')
            .replace(/\{/g, '(')
            .replace(/\}/g, ')');
    }

    function handleSubmitAnswer(answerInputId, encodedAnswer) {
        const answerInput = document.getElementById(answerInputId);
        const feedbackDiv = document.getElementById(`feedback-${answerInputId}`);

        const rawCorrectAnswer = atob(encodedAnswer);
        const userAnswer = answerInput.value;

        feedbackDiv.classList.remove('feedback-correct', 'feedback-incorrect');

        if (userAnswer.trim() === '') {
            feedbackDiv.textContent = 'Please type an answer.';
            feedbackDiv.classList.add('feedback-incorrect');
            return;
        }

        try {
            const cleanCorrectAnswer = preProcessForMathJS(rawCorrectAnswer);

            const simplifiedUserAnswer = math.simplify(userAnswer).toString();
            const simplifiedCorrectAnswer = math.simplify(cleanCorrectAnswer).toString();

            if (simplifiedUserAnswer === simplifiedCorrectAnswer) {
                feedbackDiv.textContent = 'Correct! Great job!';
                feedbackDiv.classList.add('feedback-correct');
            } else {
                feedbackDiv.textContent = 'Not quite. Your answer simplifies to a different expression. Try again!';
                feedbackDiv.classList.add('feedback-incorrect');
            }
        } catch (error) {
            console.error("Math.js parsing error:", error);
            feedbackDiv.textContent = 'Could not parse your answer. Please check the syntax.';
            feedbackDiv.classList.add('feedback-incorrect');
        }
    }

    function clearAnswer(answerInputId) {
        const answerInput = document.getElementById(answerInputId);
        const feedbackDiv = document.getElementById(`feedback-${answerInputId}`);

        answerInput.value = '';
        feedbackDiv.innerHTML = '';
        feedbackDiv.classList.remove('feedback-correct', 'feedback-incorrect');
    }
</script>